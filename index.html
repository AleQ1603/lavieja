<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tic Tac Toe 8-Bit Extreme Responsive</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #00ff41; --bg: #000; --x-color: #ff003c; --o-color: #00e5ff; --tie-color: #ffcc00; }
        
        body { 
            font-family: 'Courier New', Courier, monospace; 
            background: var(--bg); color: #fff; 
            display: flex; flex-direction: column; align-items: center; 
            padding: 5px; margin: 0; min-height: 100vh; width: 100vw;
            box-sizing: border-box; overflow-x: hidden;
        }

        .card { background: #111; padding: 8px; border-radius: 4px; border: 2px solid #333; margin-bottom: 5px; width: 95%; max-width: 800px; text-align: center; }
        input, select { background: #000; border: 1px solid #555; color: var(--primary); padding: 8px; margin: 4px; width: 85%; font-family: inherit; font-size: 14px; }
        button { background: var(--primary); border: none; color: #000; padding: 10px 20px; cursor: pointer; font-weight: bold; text-transform: uppercase; }
        
        /* Contenedor Adaptativo */
        .board-container { 
            position: relative; 
            margin: 5px auto; 
            border: 4px solid #444; 
            background: #222; 
            line-height: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .board { display: grid; gap: 4px; background: #333; }
        .cell { 
            background: #000; aspect-ratio: 1/1; 
            display: flex; align-items: center; justify-content: center; 
            font-weight: bold; cursor: pointer; position: relative;
        }
        
        #win-line { position: absolute; z-index: 100; display: none; pointer-events: none; height: 6px; background: #fff; transform-origin: center left; box-shadow: 0 0 15px currentColor; animation: laser-draw 0.5s forwards; }
        @keyframes laser-draw { 0% { scale: 0 1; } 100% { scale: 1 1; } }
        
        .status { font-size: 1.1rem; color: var(--primary); margin: 5px 0; text-transform: uppercase; font-weight: bold; text-align: center; }
        .scoreboard { display: flex; justify-content: space-around; width: 95%; max-width: 800px; background: #111; padding: 8px; border: 2px solid #333; margin-top: 5px; }
        .score-val { font-size: 1.4rem; display: block; color: var(--primary); }
        
        .history-panel { width: 95%; max-width: 800px; margin-top: 8px; background: #080808; border: 1px solid #222; }
        .history-item { font-size: 0.8rem; padding: 4px 10px; display: flex; justify-content: space-between; border-left: 4px solid #333; margin: 2px; background: #111; }
        .win-X { border-color: var(--x-color); color: var(--x-color); }
        .win-O { border-color: var(--o-color); color: var(--o-color); }
        .win-tie { border-color: var(--tie-color); color: var(--tie-color); }
        
        .btn-danger { background: #300; color: #f55; font-size: 10px; margin: 10px 0; border: 1px solid #600; padding: 5px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="card" id="setup-panel">
    <input type="text" id="p-name" placeholder="TU_NOMBRE" maxlength="12" oninput="saveName(this.value)">
    <select id="size-select" onchange="if(isHost) resetGame('random')">
        <option value="3">MODO 3x3</option>
        <option value="6">MODO 6x6</option>
        <option value="9">MODO 9x9</option>
    </select>
    <div id="link-section" class="hidden">
        <input type="text" id="share-url" readonly style="width: 60%; font-size: 10px;">
        <button onclick="copyLink()" style="padding: 5px; font-size: 10px;">COPIAR</button>
    </div>
</div>

<div class="status" id="status">INICIANDO...</div>

<div class="board-container" id="main-container">
    <div id="board" class="board"></div>
    <div id="win-line"></div>
</div>

<button id="rematch-btn" class="hidden" onclick="resetAfterWin()" style="margin: 10px 0;">SIGUIENTE RONDA</button>

<div class="scoreboard">
    <div><b id="name-x">X</b><span class="score-val" id="win-x">0</span></div>
    <div><b>TIE</b><span class="score-val" id="win-tie">0</span></div>
    <div><b id="name-o">O</b><span class="score-val" id="win-o">0</span></div>
</div>

<div class="history-panel" id="history-panel">
    <div id="history-list"></div>
</div>

<button class="btn-danger" onclick="clearScores()">REINICIAR MARCADOR</button>

<script>
    // --- CONFIGURACIÓN Y PERSISTENCIA ---
    document.getElementById('p-name').value = localStorage.getItem('ttt_player_name') || "";
    function saveName(val) { 
        localStorage.setItem('ttt_player_name', val);
        if(mySymbol === turn) gameRef.child('players').child(mySymbol).set(val || `JUGADOR ${mySymbol}`);
    }

    function clearScores() {
        if(confirm("¿Está seguro de querer reiniciar los puntos y el historial?")) {
            localStorage.setItem('ttt_8bit_vFinal', JSON.stringify({X:0, O:0, tie:0}));
            gameRef.child('history').remove();
            updateScoresDisplay();
        }
    }

    // --- AUDIO ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSfx(f, type, d) {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator(); const g = audioCtx.createGain();
        osc.type = type; f.forEach((v, i) => osc.frequency.setValueAtTime(v, audioCtx.currentTime + (i * d/f.length)));
        g.gain.setValueAtTime(0.03, audioCtx.currentTime); g.gain.linearRampToValueAtTime(0, audioCtx.currentTime + d);
        osc.connect(g); g.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + d);
    }
    const sfx = { move:()=>playSfx([200,400],'square',0.05), win:()=>playSfx([400,600,900],'square',0.4), tie:()=>playSfx([300,100],'sawtooth',0.3), res:()=>playSfx([600,800],'square',0.2) };

    // --- FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyCLjLoz8I7ZnR-xWJ6-ltQfLGOHrGQWS-I",
        authDomain: "lavieja-aa32d.firebaseapp.com",
        databaseURL: "https://lavieja-aa32d-default-rtdb.firebaseio.com/",
        projectId: "lavieja-aa32d",
        storageBucket: "lavieja-aa32d.firebasestorage.app",
        messagingSenderId: "73070638433",
        appId: "1:73070638433:web:b4758e7ad14ccd54810120"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const urlParams = new URLSearchParams(window.location.search);
    let gameId = urlParams.get('game') || Math.random().toString(36).substring(7);
    let gameRef = db.ref('games/' + gameId);

    let mySymbol="", boardSize=3, winTarget=3, board=[], turn="X", isHost=!urlParams.get('game'), gameActive=true, lastWinID="", winnerOfLastRound = null;

    if (isHost) {
        mySymbol = Math.random() > 0.5 ? "X" : "O";
        document.getElementById('share-url').value = window.location.origin + window.location.pathname + "?game=" + gameId;
        document.getElementById('link-section').classList.remove('hidden');
    }

    // REDIMENSIONAMIENTO AUTOMÁTICO
    window.addEventListener('resize', renderBoard);

    gameRef.on('value', (snap) => {
        const data = snap.val();
        if (!data) { if(isHost) initDB(); return; }
        if (board.length > 0 && JSON.stringify(board) !== JSON.stringify(data.board)) sfx.move();

        boardSize = data.size || 3;
        winTarget = boardSize == 3 ? 3 : (boardSize == 6 ? 4 : 5);
        board = data.board; turn = data.turn;
        winnerOfLastRound = data.winner;
        if (!mySymbol) mySymbol = data.hostSymbol === "X" ? "O" : "X";

        renderBoard();
        updateHistory(data.history);
        
        const currentTurnName = data.players ? (data.players[turn] || `JUGADOR ${turn}`) : `JUGADOR ${turn}`;

        if (data.winner && lastWinID !== data.winTime) {
            lastWinID = data.winTime;
            applyWin(data.winner, data.winLine, data.players);
        } else if (!data.winner) {
            gameActive = true;
            document.getElementById('status').innerText = `TURNO DE: ${currentTurnName}`;
            document.getElementById('rematch-btn').classList.add('hidden');
            document.getElementById('win-line').style.display = "none";
        }

        if (data.players) {
            document.getElementById('name-x').innerText = data.players.X || "X";
            document.getElementById('name-o').innerText = data.players.O || "O";
        }
        updateScoresDisplay();
    });

    function initDB() {
        const sz = parseInt(document.getElementById('size-select').value);
        gameRef.set({ size: sz, board: Array(sz*sz).fill(""), turn: (Math.random() > 0.5 ? "X" : "O"), hostSymbol: mySymbol, winner: null, players: {[mySymbol]: document.getElementById('p-name').value || `JUGADOR ${mySymbol}`} });
    }

    function renderBoard() {
        const bDiv = document.getElementById('board');
        bDiv.style.gridTemplateColumns = `repeat(${boardSize}, 1fr)`;
        
        // CALCULO MAESTRO DE ESPACIO
        // Restamos espacio de UI superior e inferior dinámicamente
        const vSpace = window.innerHeight - 340; 
        const hSpace = window.innerWidth - 40;
        
        // El tablero será un cuadrado perfecto ocupando el máximo posible
        const size = Math.min(vSpace, hSpace, 800); 
        
        bDiv.style.width = size + "px";
        bDiv.style.height = size + "px";
        
        bDiv.innerHTML = "";
        board.forEach((v, i) => {
            const c = document.createElement('div'); c.className = 'cell';
            const fs = (size / boardSize) * 0.7; // Fuente proporcional al tamaño de celda
            c.style.fontSize = fs + "px";
            c.innerText = v; 
            c.style.color = v==="X" ? "var(--x-color)":"var(--o-color)";
            c.onclick = () => makeMove(i); 
            bDiv.appendChild(c);
        });
    }

    function makeMove(i) {
        if (board[i] === "" && turn === mySymbol && gameActive) {
            board[i] = mySymbol;
            gameRef.update({ board: board, turn: turn === "X" ? "O" : "X", [`players/${mySymbol}`]: document.getElementById('p-name').value || `JUGADOR ${mySymbol}` });
            checkWin();
        }
    }

    function checkWin() {
        const lines = getLines();
        for (let l of lines) {
            if (l.every(idx => board[idx] === mySymbol)) {
                pushHistory(mySymbol);
                gameRef.update({ winner: mySymbol, winLine: l, winTime: Date.now() });
                return;
            }
        }
        if (!board.includes("")) {
            pushHistory("tie");
            gameRef.update({ winner: "tie", winTime: Date.now() });
        }
    }

    function pushHistory(w) {
        gameRef.child('history').once('value', (s) => {
            let h = s.val() || [];
            const nameX = document.getElementById('name-x').innerText;
            const nameO = document.getElementById('name-o').innerText;
            let entry = w === 'tie' ? "EMPATE" : (w === 'X' ? nameX : nameO);
            h.unshift({ winner: w, name: entry, time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) });
            if(h.length > 5) h.pop();
            gameRef.update({ history: h });
        });
    }

    function updateHistory(history) {
        const list = document.getElementById('history-list');
        list.innerHTML = ""; if(!history) return;
        history.forEach(item => {
            const div = document.createElement('div');
            div.className = `history-item win-${item.winner}`;
            div.innerHTML = `<span>▶ ${item.name}</span> <span>${item.time}</span>`;
            list.appendChild(div);
        });
    }

    function applyWin(w, line, players) {
        gameActive = false;
        w === "tie" ? sfx.tie() : sfx.win();
        const winnerName = players ? (players[w] || `JUGADOR ${w}`) : w;
        document.getElementById('status').innerText = w === "tie" ? "EMPATE" : `¡${winnerName} GANA!`;
        document.getElementById('rematch-btn').classList.remove('hidden');
        
        let s = JSON.parse(localStorage.getItem('ttt_8bit_vFinal')) || {X:0, O:0, tie:0};
        s[w]++; localStorage.setItem('ttt_8bit_vFinal', JSON.stringify(s));
        updateScoresDisplay();
        if (line) drawLaser(line, w);
    }

    function drawLaser(indices, w) {
        const laser = document.getElementById('win-line');
        const cells = document.querySelectorAll('.cell');
        const bRect = document.getElementById('board').getBoundingClientRect();
        const fCell = cells[indices[0]].getBoundingClientRect();
        const lCell = cells[indices[indices.length-1]].getBoundingClientRect();
        const x1 = (fCell.left + fCell.width/2) - bRect.left;
        const y1 = (fCell.top + fCell.height/2) - bRect.top;
        const x2 = (lCell.left + lCell.width/2) - bRect.left;
        const y2 = (lCell.top + lCell.height/2) - bRect.top;
        laser.style.width = Math.sqrt((x2-x1)**2 + (y2-y1)**2) + "px";
        laser.style.left = x1 + "px"; laser.style.top = y1 + "px";
        laser.style.transform = `rotate(${Math.atan2(y2-y1, x2-x1) * 180 / Math.PI}deg)`;
        laser.style.backgroundColor = w === 'X' ? 'var(--x-color)' : 'var(--o-color)';
        laser.style.display = "block";
    }

    function getLines() {
        let l = [];
        for (let r=0; r<boardSize; r++) { for (let c=0; c<=boardSize-winTarget; c++) {
            let h=[], v=[]; for(let k=0; k<winTarget; k++) { h.push(r*boardSize + (c+k)); v.push((c+k)*boardSize + r); }
            l.push(h); l.push(v);
        }}
        for (let r=0; r<=boardSize-winTarget; r++) { for (let c=0; c<=boardSize-winTarget; c++) {
            let d1=[], d2=[]; for(let k=0; k<winTarget; k++) { d1.push((r+k)*boardSize + (c+k)); d2.push((r+k)*boardSize + (c+winTarget-1-k)); }
            l.push(d1); l.push(d2);
        }}
        return l;
    }

    function resetAfterWin() {
        let nextTurn = (winnerOfLastRound && winnerOfLastRound !== "tie") ? winnerOfLastRound : (Math.random() > 0.5 ? "X" : "O");
        resetGame(nextTurn);
    }

    function resetGame(forcedTurn) {
        sfx.res();
        const sz = parseInt(document.getElementById('size-select').value);
        gameRef.update({ board: Array(sz*sz).fill(""), turn: forcedTurn === 'random' ? (Math.random() > 0.5 ? "X" : "O") : forcedTurn, winner: null, winLine: null, winTime: null, size: sz });
    }

    function updateScoresDisplay() {
        const s = JSON.parse(localStorage.getItem('ttt_8bit_vFinal')) || {X:0, O:0, tie:0};
        document.getElementById('win-x').innerText = s.X; document.getElementById('win-o').innerText = s.O; document.getElementById('win-tie').innerText = s.tie;
    }

    function copyLink() { navigator.clipboard.writeText(document.getElementById('share-url').value); alert("LINK_COPIADO"); }
</script>
</body>
</html>